<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pra onde vou</title>
    <script
            src="https://code.jquery.com/jquery-3.5.1.min.js"
            integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
            crossorigin="anonymous"></script>

    <script defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA5iEFHHRkp9Gb3QH2MYY2Te4Q5bKISYqA&callback=initMap">
    </script>

    <script>
        let map;

        const LENGTH_ZIP_CODE = 8;

        const getAddress = () => {

            let zipCode = document.getElementById("zipCode").value;
            // Validação do campo para aceitar apenas números.
            // Caso usuário tente colocar letras, pontos ou caracteres especiais
            // o campo não irá aceitar.
            zipCode = String(zipCode).replace(/[^0-9]/g,'');
            document.getElementById("zipCode").value = zipCode;

            if(String(zipCode).length === LENGTH_ZIP_CODE){
                fetch(`http://viacep.com.br/ws/${zipCode}/json/`).then((body) => body.json())
                    .then((data) => {
                        if (data.erro){
                            return;
                        }else{
                            document.getElementById("bairro").value = data.bairro;
                            document.getElementById("estado").value = data.localidade;
                            document.getElementById("nomeLocalidade").value = data.logradouro;
                        }
                    });
            }
        }

        const formIsValid = () => {
            fieldsIsNotEmpty() ? $("#submitForm").prop('disabled', false) : $("#submitForm").prop('disabled', true);
        }


        async function getLongAndLat() {
            const publicPlace = document.getElementById("nomeLocalidade").value;
            const number = document.getElementById("numero").value;
            const state = document.getElementById("estado").value;
            const search = publicPlace + "," + number + "," + state;
            console.log(search);
            await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${search}&key=
            AIzaSyA5iEFHHRkp9Gb3QH2MYY2Te4Q5bKISYqA`)
                .then((body) => body.json())
                .then(data => {
                console.log(data);
            });
        }

        async function initMap(){

            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 8,
                center: { lat: -22.886360, lng: -47.165580 },
            });
        }

        const fieldsIsNotEmpty = () => document.getElementById("bairro").value !== "" &&
            document.getElementById("estado").value !== "" &&
            document.getElementById("nomeLocalidade").value !== "" &&
            document.getElementById("zipCode").value !== "" &&
            document.getElementById("numero").value !== "";
    </script>
</head>

<body>

    <form action="/pontos">

        <input placeholder="CEP" name="cep" maxlength="10" onblur="formIsValid()" onkeyup="getAddress()" id="zipCode" type="text">
        <input placeholder="Número" name="numero" onblur="formIsValid()" id="numero" type="text">
        <input placeholder="Bairro" name="bairro" onblur="formIsValid()" id="bairro" type="text">
        <input placeholder="Estado" name="estado" onblur="formIsValid()" id="estado" type="text">
        <input placeholder="Nome da nomeLocalidadelocalidade" name="nomeLocalidade" onblur="formIsValid()" id="nomeLocalidade" type="text">

        <button disabled id="submitForm" onclick="getLongAndLat()" type="submit">Cadastrar um ponto</button>
    </form>


    <main onload="initMap">
        <section class="content">
            <div class="map" id="map"></div>
        </section>
    </main>
</body>
</html>